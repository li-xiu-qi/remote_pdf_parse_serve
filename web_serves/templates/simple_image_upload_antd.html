{% extends "simple_base_antd.html" %}

{% block title %}å›¾ç‰‡ä¸Šä¼  - æ–‡ä»¶å¤„ç†æœåŠ¡{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h1 style="margin-bottom: 24px; color: #262626;">å›¾ç‰‡ä¸Šä¼ </h1>
    
    <!-- Upload Area -->
    <div id="imageUploadArea" class="upload-dragger" style="margin-bottom: 24px;">
        <div style="padding: 20px;">
            <div style="font-size: 48px; color: #1890ff; margin-bottom: 16px;">ğŸ“</div>
            <p style="font-size: 16px; margin-bottom: 8px;">å°†å›¾ç‰‡æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <p style="color: #8c8c8c; margin: 0;">æ”¯æŒ JPG, PNG, GIF, WEBP ç­‰æ ¼å¼ï¼Œå¯é€‰æ‹©å¤šä¸ªæ–‡ä»¶</p>
        </div>
        <input type="file" id="imageFileInput" multiple accept="image/*" style="display: none;">
    </div>

    <!-- Controls -->
    <div style="margin-bottom: 24px; display: flex; gap: 12px; align-items: center;">
        <button id="uploadBtn" class="ant-btn ant-btn-primary" style="height: 40px; padding: 0 24px; font-size: 14px;" disabled>
            <span id="uploadBtnText">ä¸Šä¼ å›¾ç‰‡</span>
        </button>
        <button id="clearBtn" class="ant-btn" style="height: 40px; padding: 0 16px;">
            æ¸…ç©ºåˆ—è¡¨
        </button>
        <span id="fileCount" style="color: #8c8c8c; font-size: 14px;">æœªé€‰æ‹©æ–‡ä»¶</span>
    </div>

    <!-- Progress -->
    <div id="progressContainer" style="margin-bottom: 24px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="color: #262626; font-weight: 500;">ä¸Šä¼ è¿›åº¦</span>
            <span id="progressText" style="color: #8c8c8c; font-size: 14px;">0%</span>
        </div>
        <div style="background: #f5f5f5; border-radius: 6px; overflow: hidden; height: 12px; position: relative;">
            <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #1890ff, #36cfc9); width: 0%; transition: width 0.3s ease; position: relative; border-radius: 6px;">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
            </div>
        </div>
    </div>

    <!-- Preview Area -->
    <div id="previewSection" style="margin-bottom: 32px; display: none;">
        <h3 style="margin-bottom: 16px; color: #262626;">é¢„è§ˆ</h3>
        <div id="previewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px;">
            <!-- Preview images will be inserted here -->
        </div>
    </div>

    <!-- Uploaded Files -->
    <div id="uploadedSection">
        <h3 style="margin-bottom: 16px; color: #262626; display: flex; align-items: center; justify-content: space-between;">
            <span>å·²ä¸Šä¼ çš„æ–‡ä»¶</span>
            <span id="uploadedCount" style="background: #f0f2f5; color: #8c8c8c; font-size: 12px; font-weight: normal; padding: 4px 8px; border-radius: 12px; min-width: 20px; text-align: center;">0</span>
        </h3>
        <div id="uploadedContainer" style="border: 1px solid #e8e8e8; border-radius: 8px; background: #fafafa;">
            <div id="emptyState" style="padding: 40px; text-align: center; color: #8c8c8c;">
                ğŸ“ è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶
                <div style="font-size: 12px; margin-top: 8px; color: #bfbfbf;">ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
            </div>
            <div id="uploadedList" style="display: none;">
                <!-- Uploaded file list will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('imageUploadArea');
    const fileInput = document.getElementById('imageFileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileCount = document.getElementById('fileCount');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const previewSection = document.getElementById('previewSection');
    const previewContainer = document.getElementById('previewContainer');
    const uploadedContainer = document.getElementById('uploadedContainer');
    const emptyState = document.getElementById('emptyState');
    const uploadedList = document.getElementById('uploadedList');
    const uploadBtnText = document.getElementById('uploadBtnText');

    let filesToUpload = [];
    let isUploading = false;
    let messageQueue = [];

    // Custom notification system
    function showAlert(content, type = 'info', duration = 5) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: ${80 + messageQueue.length * 60}px;
            right: 20px;
            z-index: 1001;
            padding: 12px 16px;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-left: 4px solid ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : type === 'warning' ? '#faad14' : '#1890ff'};
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        `;
        alertDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</span>
                <span style="color: #262626; font-size: 14px;">${content}</span>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        messageQueue.push(alertDiv);
        
        setTimeout(() => {
            alertDiv.style.opacity = '1';
            alertDiv.style.transform = 'translateX(0)';
        }, 100);
        
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                    messageQueue = messageQueue.filter(msg => msg !== alertDiv);
                    messageQueue.forEach((msg, index) => {
                        msg.style.top = `${80 + index * 60}px`;
                    });
                }
            }, 300);
        }, duration * 1000);
    }

    // Setup drag and drop
    setupDragAndDrop('imageUploadArea', 'imageFileInput', handleFiles);

    // Clear button
    clearBtn.addEventListener('click', function() {
        filesToUpload = [];
        fileInput.value = '';
        updateUI();
        showAlert('æ–‡ä»¶åˆ—è¡¨å·²æ¸…ç©º', 'info');
    });

    // Upload button
    uploadBtn.addEventListener('click', function() {
        if (filesToUpload.length === 0 || isUploading) return;
        uploadFiles();
    });

    function handleFiles(files) {
        const newFiles = Array.from(files).filter(file => {
            if (!file.type.startsWith('image/')) {
                showAlert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œå·²å¿½ç•¥`, 'warning');
                return false;
            }
            if (filesToUpload.some(f => f.name === file.name && f.size === file.size)) {
                showAlert(`æ–‡ä»¶ ${file.name} å·²åœ¨åˆ—è¡¨ä¸­`, 'info');
                return false;
            }
            return true;
        });

        filesToUpload.push(...newFiles);
        updateUI();
        
        if (newFiles.length > 0) {
            showAlert(`å·²æ·»åŠ  ${newFiles.length} ä¸ªæ–‡ä»¶åˆ°ä¸Šä¼ åˆ—è¡¨`, 'success');
        }
    }

    function updateUI() {
        if (filesToUpload.length === 0) {
            fileCount.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            uploadBtn.disabled = true;
            previewSection.style.display = 'none';
        } else {
            fileCount.textContent = `å·²é€‰æ‹© ${filesToUpload.length} ä¸ªæ–‡ä»¶`;
            uploadBtn.disabled = false;
            updatePreview();
            previewSection.style.display = 'block';
        }

        if (isUploading) {
            uploadBtn.disabled = true;
            uploadBtnText.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>ä¸Šä¼ ä¸­...';
        } else {
            uploadBtnText.textContent = 'ä¸Šä¼ å›¾ç‰‡';
        }
    }

    function updatePreview() {
        previewContainer.innerHTML = '';
        filesToUpload.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.style.cssText = 'position: relative; border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; background: white; transition: all 0.3s ease; cursor: pointer; opacity: 0; transform: scale(0.9);';
                previewItem.className = 'file-item-hover';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" style="width: 100%; height: 100px; object-fit: cover; display: block; transition: transform 0.3s ease;">
                    <div style="padding: 8px; font-size: 12px; color: #8c8c8c; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">
                        ${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}
                    </div>
                    <div style="padding: 0 8px 8px; font-size: 11px; color: #bfbfbf; text-align: center;">
                        ${formatFileSize(file.size)}
                    </div>
                    <button onclick="removeFile(${index})" style="position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border: none; border-radius: 50%; background: rgba(255, 77, 79, 0.9); color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; opacity: 0.8;" 
                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" 
                        onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">Ã—</button>
                    <div style="position: absolute; top: 4px; left: 4px; background: rgba(24, 144, 255, 0.9); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 500;">
                        ${index + 1}
                    </div>
                `;
                
                const img = previewItem.querySelector('img');
                previewItem.addEventListener('mouseenter', () => {
                    img.style.transform = 'scale(1.05)';
                });
                previewItem.addEventListener('mouseleave', () => {
                    img.style.transform = 'scale(1)';
                });
                
                previewContainer.appendChild(previewItem);
                
                setTimeout(() => {
                    previewItem.style.transform = 'scale(1)';
                    previewItem.style.opacity = '1';
                }, 50);
            };
            reader.readAsDataURL(file);
        });
    }

    window.removeFile = function(index) {
        const previewItems = previewContainer.children;
        if (previewItems[index]) {
            previewItems[index].style.transform = 'scale(0.8)';
            previewItems[index].style.opacity = '0';
            setTimeout(() => {
                filesToUpload.splice(index, 1);
                updateUI();
                showAlert('æ–‡ä»¶å·²ç§»é™¤', 'info', 2);
            }, 200);
        }
    };

    function uploadFiles() {
        if (filesToUpload.length === 0) return;

        isUploading = true;
        updateUI();
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';

        const formData = new FormData();
        filesToUpload.forEach(file => {
            formData.append('files', file);
        });

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${window.API_BASE_URL}/upload/images`, true);

        xhr.upload.onloadstart = function() {
            progressText.textContent = 'å¼€å§‹ä¸Šä¼ ...';
            showAlert('å¼€å§‹ä¸Šä¼ æ–‡ä»¶', 'info', 2);
        };

        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percent = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = `ä¸Šä¼ ä¸­... ${percent}% (${formatFileSize(event.loaded)} / ${formatFileSize(event.total)})`;
                uploadBtnText.innerHTML = `<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>ä¸Šä¼ ä¸­ ${percent}%`;
            }
        };        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const result = JSON.parse(xhr.responseText);
                    
                    // å¤„ç†æœåŠ¡å™¨è¿”å›çš„å“åº”æ ¼å¼
                    const uploadedFiles = result.uploaded_files || [];
                    const failedFiles = result.failed_files || [];
                    const filenames = uploadedFiles.map(file => file.filename);
                    
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'linear-gradient(90deg, #52c41a, #73d13d)';
                    progressText.textContent = `ä¸Šä¼ å®Œæˆï¼æˆåŠŸä¸Šä¼  ${uploadedFiles.length} ä¸ªæ–‡ä»¶`;
                    
                    if (failedFiles.length > 0) {
                        showAlert(`âš ï¸ éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼šæˆåŠŸ ${uploadedFiles.length} ä¸ªï¼Œå¤±è´¥ ${failedFiles.length} ä¸ª`, 'warning', 5);
                        // æ˜¾ç¤ºå¤±è´¥æ–‡ä»¶è¯¦æƒ…
                        failedFiles.forEach(file => {
                            showAlert(`âŒ ${file.filename}: ${file.error}`, 'error', 8);
                        });
                    } else {
                        showAlert(`ğŸ‰ æˆåŠŸä¸Šä¼  ${uploadedFiles.length} ä¸ªæ–‡ä»¶ï¼`, 'success', 3);
                    }
                      if (filenames.length > 0) {
                        // ä¼ é€’ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶ä¿¡æ¯è€Œä¸æ˜¯åŸå§‹æ–‡ä»¶æ•°ç»„
                        addUploadedFiles(uploadedFiles, filesToUpload);
                    }
                    
                    setTimeout(() => {
                        progressContainer.style.opacity = '0';
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            progressContainer.style.opacity = '1';
                            progressBar.style.background = 'linear-gradient(90deg, #1890ff, #36cfc9)';
                            progressBar.style.width = '0%';
                            progressText.textContent = '0%';
                        }, 500);
                    }, 1500);
                    
                    setTimeout(() => {
                        filesToUpload = [];
                        fileInput.value = '';
                        updateUI();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error parsing response:', error);
                    showAlert('æœåŠ¡å™¨å“åº”è§£æå¤±è´¥', 'error');
                    resetUploadState();
                }
            } else {
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    showAlert(`ä¸Šä¼ å¤±è´¥: ${errorData.detail || xhr.statusText}`, 'error');
                } catch (error) {
                    showAlert(`ä¸Šä¼ å¤±è´¥: ${xhr.statusText}`, 'error');
                }
                resetUploadState();
            }
            
            isUploading = false;
            updateUI();
        };

        xhr.onerror = function() {
            isUploading = false;
            updateUI();
            resetUploadState();
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥', 'error');
        };

        xhr.ontimeout = function() {
            isUploading = false;
            updateUI();
            resetUploadState();
            showAlert('ä¸Šä¼ è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        };

        xhr.timeout = 30000;
        xhr.send(formData);
    }

    function resetUploadState() {
        progressBar.style.background = '#ff4d4f';
        progressText.textContent = 'ä¸Šä¼ å¤±è´¥';
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.background = 'linear-gradient(90deg, #1890ff, #36cfc9)';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        }, 2000);
    }    function addUploadedFiles(uploadedFiles, originalFiles) {
        emptyState.style.display = 'none';
        uploadedList.style.display = 'block';

        uploadedFiles.forEach((uploadedFile, index) => {
            // æ ¹æ®æ–‡ä»¶åæŸ¥æ‰¾åŸå§‹æ–‡ä»¶ä¿¡æ¯
            const originalFile = originalFiles.find(f => f.name === uploadedFile.original_filename) || originalFiles[index];
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #e8e8e8; background: white; opacity: 0; transform: translateX(-20px); transition: all 0.3s ease;';
            fileItem.className = 'file-item-hover';
            fileItem.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #52c41a, #73d13d); border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-size: 18px;">ğŸ“·</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #262626; margin-bottom: 2px;">${uploadedFile.filename}</div>
                        <div style="font-size: 12px; color: #8c8c8c; display: flex; align-items: center; gap: 8px;">
                            <span>${originalFile ? formatFileSize(originalFile.size) : (uploadedFile.size ? formatFileSize(uploadedFile.size) : '')}</span>
                            <span style="color: #52c41a; display: flex; align-items: center;">âœ“ ä¸Šä¼ æˆåŠŸ</span>
                            <span style="color: #bfbfbf;">${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                </div>                <div style="display: flex; gap: 8px;">
                    <a href="${uploadedFile.url ? window.API_BASE_URL + uploadedFile.url : window.API_BASE_URL + '/uploads/images/' + uploadedFile.filename}" target="_blank" style="color: #1890ff; text-decoration: none; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; font-size: 12px;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='transparent'">
                        ğŸ‘ï¸ æŸ¥çœ‹
                    </a>
                    <button onclick="copyImageUrl('${uploadedFile.filename}', '${uploadedFile.url || ''}')" style="color: #722ed1; text-decoration: none; padding: 4px 8px; border: none; background: none; cursor: pointer; border-radius: 4px; transition: all 0.2s; font-size: 12px;" onmouseover="this.style.background='#f9f0ff'" onmouseout="this.style.background='transparent'">
                        ğŸ“‹ å¤åˆ¶é“¾æ¥
                    </button>
                </div>
            `;
            
            if (uploadedList.children.length === 0) {
                uploadedList.appendChild(fileItem);
            } else {
                uploadedList.insertBefore(fileItem, uploadedList.firstChild);
            }

            setTimeout(() => {
                fileItem.style.opacity = '1';
                fileItem.style.transform = 'translateX(0)';
                
                setTimeout(() => {
                    fileItem.style.background = '#f6ffed';
                    setTimeout(() => {
                        fileItem.style.background = 'white';
                    }, 1000);
                }, 300);
            }, index * 150 + 100);
        });

        updateUploadedFilesCount();
        
        setTimeout(() => {
            uploadedContainer.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, uploadedFiles.length * 150 + 500);
    }

    function updateUploadedFilesCount() {
        const count = uploadedList.children.length;
        const countElement = document.getElementById('uploadedCount');
        if (countElement) {
            countElement.textContent = count;
            
            // Add pulse animation
            countElement.style.animation = 'pulse 0.3s ease-in-out';
            setTimeout(() => {
                countElement.style.animation = '';
            }, 300);
        }
    }    window.copyImageUrl = function(filename, url) {
        const imageUrl = url ? `${window.API_BASE_URL}${url}` : `${window.API_BASE_URL}/uploads/images/${filename}`;
        navigator.clipboard.writeText(imageUrl).then(() => {
            showAlert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2);
        }).catch(() => {
            showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + imageUrl, 'error', 5);
        });
    };

    // Initialize count on page load
    updateUploadedFilesCount();
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .file-item-hover:hover {
        background: #f0f8ff !important;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.15);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
