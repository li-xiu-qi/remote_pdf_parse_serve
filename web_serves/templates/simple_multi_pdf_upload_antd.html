{% extends "simple_base_antd.html" %}

{% block title %}æ‰¹é‡PDFè§£æ - æ–‡ä»¶å¤„ç†æœåŠ¡{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <h1 style="margin-bottom: 24px; color: #262626;">æ‰¹é‡PDFæ–‡æ¡£è§£æ</h1>
    
    <!-- Upload Area -->
    <div id="pdfUploadArea" class="upload-dragger" style="margin-bottom: 24px;">
        <div style="padding: 20px;">
            <div style="font-size: 48px; color: #52c41a; margin-bottom: 16px;">ğŸ“„</div>
            <p style="font-size: 16px; margin-bottom: 8px;">å°†PDFæ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <p style="color: #8c8c8c; margin: 0;">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ªPDFæ–‡ä»¶</p>
        </div>
        <input type="file" id="pdfFileInput" accept=".pdf" multiple style="display: none;">
    </div>

    <!-- File List and Controls -->
    <div id="fileListSection" style="margin-bottom: 24px; display: none;">
        <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #262626;">å·²é€‰æ‹©çš„æ–‡ä»¶</h4>
            <div id="fileList" style="max-height: 200px; overflow-y: auto;">
                <!-- File list will be populated here -->
            </div>
            
            <div style="margin: 16px 0;">
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 12px;">
                    <input type="checkbox" id="parseImagesCheckbox" style="margin-right: 8px;">
                    <span style="color: #262626;">åŒæ—¶è§£æPDFä¸­çš„å›¾ç‰‡ï¼ˆå°†å¢åŠ å¤„ç†æ—¶é—´ï¼‰</span>
                </label>
                
                <!-- è§£æåç«¯é€‰æ‹© -->
                <div style="margin-bottom: 12px;">
                    <label for="backendSelect" style="color: #262626; margin-bottom: 6px; display: block; font-size: 14px;">è§£æåç«¯ï¼š</label>
                    <select id="backendSelect" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                        <option value="pipeline">Pipelineï¼ˆé€šç”¨ï¼‰</option>
                        <option value="vlm-transformers">VLM-Transformersï¼ˆé€šç”¨ï¼‰</option>
                        <option value="vlm-sglang-engine">VLM-SGLang-Engineï¼ˆæ›´å¿«ï¼‰</option>
                    </select>
                </div>
                
                <!-- è§£ææ–¹æ³•é€‰æ‹© -->
                <div style="margin-bottom: 12px;">
                    <label for="methodSelect" style="color: #262626; margin-bottom: 6px; display: block; font-size: 14px;">è§£ææ–¹æ³•ï¼š</label>
                    <select id="methodSelect" style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px;">
                        <option value="auto">è‡ªåŠ¨é€‰æ‹©</option>
                        <option value="txt">æ–‡æœ¬æå–</option>
                        <option value="ocr">OCRè¯†åˆ«</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button id="parseBtn" class="ant-btn ant-btn-primary" style="height: 40px; padding: 0 24px; font-size: 14px;">
                <span id="parseBtnText">å¼€å§‹æ‰¹é‡è§£æ</span>
            </button>
            <button id="clearPdfBtn" class="ant-btn" style="height: 40px; padding: 0 16px;">
                é‡æ–°é€‰æ‹©
            </button>
        </div>
    </div>

    <!-- Processing Status -->
    <div id="processingSection" style="margin-bottom: 24px; display: none;">
        <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 16px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="width: 20px; height: 20px; border: 2px solid #1890ff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;"></div>
                <span id="processingText" style="font-weight: 500; color: #0050b3;">æ­£åœ¨æ‰¹é‡å¤„ç†ä¸­...</span>
            </div>
            <div style="background: #f0f8ff; border-radius: 4px; overflow: hidden; height: 6px; margin-bottom: 8px;">
                <div id="processingProgress" style="height: 100%; background: #1890ff; width: 0%; transition: width 0.5s ease;"></div>
            </div>
            <div id="taskIdInfo" style="font-size: 12px; color: #0050b3;"></div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #595959;">æ‚¨å¯ä»¥ç¨åæŸ¥çœ‹çŠ¶æ€ï¼Œæˆ–åœ¨æ­¤é¡µé¢ç­‰å¾…ç»“æœã€‚</p>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display: none;">
        <h3 style="margin-bottom: 16px; color: #262626;">æ‰¹é‡è§£æç»“æœ</h3>
        
        <!-- Summary -->
        <div id="summarySection" style="background: #f6ffed; border: 1px solid #b7eb8f; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
            <h4 style="margin: 0 0 8px 0; color: #389e0d;">å¤„ç†æ±‡æ€»</h4>
            <div id="summaryContent"></div>
        </div>
        
        <!-- Individual Results -->
        <div id="individualResults">
            <!-- Individual document results will be inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é¡µé¢åŠ è½½å‰æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å®šæ—¶å™¨å’Œè¯·æ±‚
window.addEventListener('beforeunload', function() {
    console.log('é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº...');
    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    for (let i = 1; i < 9999; i++) {
        window.clearInterval(i);
        window.clearTimeout(i);
    }
});

// ç«‹å³æ¸…ç†ä»»ä½•æ®‹ç•™çš„å®šæ—¶å™¨
console.log('ç«‹å³æ¸…ç†æ®‹ç•™å®šæ—¶å™¨...');
for (let i = 1; i < 9999; i++) {
    window.clearInterval(i);
    window.clearTimeout(i);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('æ‰¹é‡PDFé¡µé¢åˆå§‹åŒ–å¼€å§‹...');
    
    const uploadArea = document.getElementById('pdfUploadArea');
    const fileInput = document.getElementById('pdfFileInput');
    const fileListSection = document.getElementById('fileListSection');
    const fileList = document.getElementById('fileList');
    const parseBtn = document.getElementById('parseBtn');
    const clearPdfBtn = document.getElementById('clearPdfBtn');
    const parseBtnText = document.getElementById('parseBtnText');
    const parseImagesCheckbox = document.getElementById('parseImagesCheckbox');
    const backendSelect = document.getElementById('backendSelect');
    const methodSelect = document.getElementById('methodSelect');
    const processingSection = document.getElementById('processingSection');
    const processingText = document.getElementById('processingText');
    const processingProgress = document.getElementById('processingProgress');
    const resultsSection = document.getElementById('resultsSection');
    const summaryContent = document.getElementById('summaryContent');
    const individualResults = document.getElementById('individualResults');

    let currentFiles = [];
    let isProcessing = false;

    console.log('åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½...');
    // Setup drag and drop
    setupDragAndDrop('pdfUploadArea', 'pdfFileInput', handleFiles);

    // æ·»åŠ é¢å¤–çš„ç‚¹å‡»ç›‘å¬å™¨ç”¨äºè°ƒè¯•
    if (uploadArea) {
        uploadArea.addEventListener('click', function() {
            console.log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
            if (fileInput) {
                console.log('è§¦å‘æ–‡ä»¶é€‰æ‹©');
                fileInput.click();
            } else {
                console.error('fileInput å…ƒç´ ä¸å­˜åœ¨');
            }
        });
    } else {
        console.error('uploadArea å…ƒç´ ä¸å­˜åœ¨');
    }

    // Clear button
    clearPdfBtn.addEventListener('click', function() {
        currentFiles = [];
        fileInput.value = '';
        fileListSection.style.display = 'none';
        processingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        showAlert('å·²é‡æ–°é€‰æ‹©æ–‡ä»¶', 'info');
    });

    // Parse button
    parseBtn.addEventListener('click', function() {
        if (currentFiles.length === 0 || isProcessing) return;
        startParsing();
    });

    function handleFiles(files) {
        console.log('handleFiles è¢«è°ƒç”¨ï¼Œæ–‡ä»¶æ•°é‡:', files.length);
        if (files.length === 0) return;
        
        // è¿‡æ»¤PDFæ–‡ä»¶
        const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
        
        if (pdfFiles.length === 0) {
            showAlert('è¯·é€‰æ‹©PDFæ–‡ä»¶', 'warning');
            return;
        }

        if (pdfFiles.length !== files.length) {
            showAlert(`å·²è¿‡æ»¤æ‰ ${files.length - pdfFiles.length} ä¸ªéPDFæ–‡ä»¶`, 'warning');
        }

        currentFiles = pdfFiles;
        updateFileList();
        fileListSection.style.display = 'block';
        
        // Hide previous results
        processingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        
        showAlert(`å·²é€‰æ‹© ${pdfFiles.length} ä¸ªPDFæ–‡ä»¶`, 'success');
    }

    function updateFileList() {
        fileList.innerHTML = '';
        currentFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #e8e8e8; margin-bottom: 8px;';
            fileItem.innerHTML = `
                <div style="width: 32px; height: 32px; background: #52c41a; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-size: 14px;">ğŸ“„</div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #262626; margin-bottom: 2px;">${file.name}</div>
                    <div style="font-size: 12px; color: #8c8c8c;">${formatFileSize(file.size)}</div>
                </div>
                <button onclick="removeFile(${index})" style="background: none; border: none; color: #ff4d4f; cursor: pointer; padding: 4px; font-size: 16px;">âœ•</button>
            `;
            fileList.appendChild(fileItem);
        });
    }

    window.removeFile = function(index) {
        currentFiles.splice(index, 1);
        if (currentFiles.length === 0) {
            fileListSection.style.display = 'none';
        } else {
            updateFileList();
        }
        showAlert('æ–‡ä»¶å·²ç§»é™¤', 'info');
    };

    async function startParsing() {
        if (currentFiles.length === 0) return;

        isProcessing = true;
        parseBtn.disabled = true;
        parseBtnText.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>æ­£åœ¨å¤„ç†...';
        processingSection.style.display = 'block';
        processingText.textContent = `æ­£åœ¨å¤„ç† ${currentFiles.length} ä¸ªPDFæ–‡æ¡£...`;
        processingProgress.style.width = '0%';

        const formData = new FormData();
        currentFiles.forEach(file => {
            formData.append('files', file);
        });
        formData.append('parse_images', parseImagesCheckbox.checked);
        formData.append('backend', backendSelect.value);
        formData.append('method', methodSelect.value);
        
        console.log('æ‰¹é‡å¤„ç†å‚æ•°:');
        console.log('æ–‡ä»¶æ•°é‡:', currentFiles.length);
        console.log('parse_images:', parseImagesCheckbox.checked);
        console.log('backend:', backendSelect.value);
        console.log('method:', methodSelect.value);

        try {
            const response = await fetch(`${window.API_BASE_URL}/upload/pdfs`, {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                const result = await response.json();
                showAlert(`æ‰¹é‡PDFå¤„ç†æˆåŠŸï¼Œä»»åŠ¡ID: ${result.task_id}`, 'success');
                
                // æ˜¾ç¤ºç»“æœ
                displayBatchResults(result);
                processingProgress.style.width = '100%';
                processingText.textContent = 'æ‰¹é‡å¤„ç†å®Œæˆï¼';
                showAlert('æ‰¹é‡PDFè§£æå®Œæˆï¼', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || response.statusText);
            }
        } catch (error) {
            console.error('Batch upload error:', error);
            showAlert(`æ‰¹é‡PDFå¤„ç†å¤±è´¥: ${error.message}`, 'error');
        } finally {
            resetProcessingState();
        }
    }

    function displayBatchResults(data) {
        // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
        summaryContent.innerHTML = `
            <p style="margin: 0 0 8px 0;"><strong>æ€»æ–‡ä»¶æ•°ï¼š</strong>${data.summary.total_documents}</p>
            <p style="margin: 0 0 8px 0;"><strong>æˆåŠŸå¤„ç†ï¼š</strong>${data.summary.processed_count}</p>
            <p style="margin: 0;"><strong>å¤„ç†ç»“æœï¼š</strong>${data.summary.message}</p>
        `;

        // æ˜¾ç¤ºæ¯ä¸ªæ–‡æ¡£çš„ç»“æœ
        individualResults.innerHTML = '';
        data.documents.forEach((doc, index) => {
            const docResult = document.createElement('div');
            docResult.style.cssText = 'border: 1px solid #e8e8e8; border-radius: 8px; margin-bottom: 16px; overflow: hidden;';
            
            const hasImages = doc.markdown.has_images;
            const imagesProcessed = doc.markdown.images_processed;
            
            // ç¡®å®šå›¾ç‰‡çŠ¶æ€
            let imageStatus;
            if (hasImages) {
                imageStatus = imagesProcessed ? 'å·²å¤„ç†' : 'æœªå¤„ç†';
            } else {
                imageStatus = 'æ— ';
            }
            
            docResult.innerHTML = `
                <div style="background: #fafafa; padding: 12px; border-bottom: 1px solid #e8e8e8;">
                    <h4 style="margin: 0; color: #262626;">${doc.document.original_name}</h4>
                    <div style="font-size: 12px; color: #8c8c8c; margin-top: 4px;">
                        å¤§å°: ${formatFileSize(doc.document.size_bytes)} | 
                        å›¾ç‰‡: ${imageStatus}
                    </div>
                </div>
                <div style="padding: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h5 style="margin: 0; color: #262626;">Markdownå†…å®¹</h5>
                        <button onclick="copyMarkdown(${index})" class="ant-btn ant-btn-link" style="color: #1890ff; padding: 4px 8px;">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                    </div>
                    <div style="border: 1px solid #e8e8e8; border-radius: 8px; background: white; max-height: 300px; overflow-y: auto;">
                        <pre id="markdownContent${index}" style="margin: 0; padding: 16px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; line-height: 1.4;">${doc.markdown.content}</pre>
                    </div>
                </div>
            `;
            individualResults.appendChild(docResult);
        });

        resultsSection.style.display = 'block';

        // Hide processing section after a delay
        setTimeout(() => {
            processingSection.style.display = 'none';
        }, 2000);
    }

    window.copyMarkdown = function(index) {
        const content = document.getElementById(`markdownContent${index}`).textContent;
        navigator.clipboard.writeText(content).then(() => {
            showAlert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
        });
    };

    function resetProcessingState() {
        isProcessing = false;
        parseBtn.disabled = false;
        parseBtnText.textContent = 'å¼€å§‹æ‰¹é‡è§£æ';
    }

    // Add CSS for spinner animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
