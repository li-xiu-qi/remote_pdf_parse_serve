{% extends "simple_base_antd.html" %}

{% block title %}PDFè§£æ - æ–‡ä»¶å¤„ç†æœåŠ¡{% endblock %}

{% block head_extra %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h1 style="margin-bottom: 24px; color: #262626;">PDFæ–‡æ¡£è§£æ</h1>
    
    <!-- Upload Area -->
    <div id="pdfUploadArea" class="upload-dragger" style="margin-bottom: 24px;">
        <div style="padding: 20px;">
            <div style="font-size: 48px; color: #52c41a; margin-bottom: 16px;">ğŸ“„</div>
            <p style="font-size: 16px; margin-bottom: 8px;">å°†PDFæ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <p style="color: #8c8c8c; margin: 0;">ä»…æ”¯æŒå•ä¸ªPDFæ–‡ä»¶ä¸Šä¼ </p>
        </div>
        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
    </div>

    <!-- File Info and Controls -->
    <div id="fileInfoSection" style="margin-bottom: 24px; display: none;">
        <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: #52c41a; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-size: 18px;">ğŸ“„</div>
                <div style="flex: 1;">
                    <div id="fileName" style="font-weight: 500; color: #262626; margin-bottom: 2px;"></div>
                    <div id="fileSize" style="font-size: 12px; color: #8c8c8c;"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="parseImagesCheckbox" style="margin-right: 8px;">
                    <span style="color: #262626;">åŒæ—¶è§£æPDFä¸­çš„å›¾ç‰‡ï¼ˆå°†å¢åŠ å¤„ç†æ—¶é—´ï¼‰</span>
                </label>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button id="parseBtn" class="ant-btn ant-btn-primary" style="height: 40px; padding: 0 24px; font-size: 14px;">
                <span id="parseBtnText">å¼€å§‹è§£æ</span>
            </button>
            <button id="clearPdfBtn" class="ant-btn" style="height: 40px; padding: 0 16px;">
                é‡æ–°é€‰æ‹©
            </button>
        </div>
    </div>

    <!-- PDF Preview -->
    <div id="previewSection" style="margin-bottom: 24px; display: none;">
        <h3 style="margin-bottom: 16px; color: #262626;">æ–‡ä»¶é¢„è§ˆ</h3>
        <div style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; background: white;">
            <iframe id="pdfPreview" style="width: 100%; height: 500px; border: none; display: block;"></iframe>
        </div>
    </div>

    <!-- Processing Status -->
    <div id="processingSection" style="margin-bottom: 24px; display: none;">
        <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 16px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="width: 20px; height: 20px; border: 2px solid #1890ff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;"></div>
                <span id="processingText" style="font-weight: 500; color: #0050b3;">æ­£åœ¨å¤„ç†ä¸­...</span>
            </div>
            <div style="background: #f0f8ff; border-radius: 4px; overflow: hidden; height: 6px; margin-bottom: 8px;">
                <div id="processingProgress" style="height: 100%; background: #1890ff; width: 0%; transition: width 0.5s ease;"></div>
            </div>
            <div id="taskIdInfo" style="font-size: 12px; color: #0050b3;"></div>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #595959;">æ‚¨å¯ä»¥ç¨åæŸ¥çœ‹çŠ¶æ€ï¼Œæˆ–åœ¨æ­¤é¡µé¢ç­‰å¾…ç»“æœã€‚</p>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display: none;">
        <h3 style="margin-bottom: 16px; color: #262626;">è§£æç»“æœ</h3>
        
        <!-- Markdown Content -->
        <div style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h4 style="margin: 0; color: #262626;">Markdownå†…å®¹</h4>
                <button id="copyMarkdownBtn" class="ant-btn ant-btn-link" style="color: #1890ff; padding: 4px 8px;">
                    ğŸ“‹ å¤åˆ¶å†…å®¹
                </button>
            </div>
            <div style="border: 1px solid #e8e8e8; border-radius: 8px; background: white; max-height: 400px; overflow-y: auto;">
                <pre id="markdownContent" style="margin: 0; padding: 16px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.5;"></pre>
            </div>
        </div>

        <!-- Extracted Images -->
        <div id="imagesSection" style="display: none;">
            <h4 style="margin-bottom: 16px; color: #262626;">æå–çš„å›¾ç‰‡</h4>
            <div id="imagesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
                <!-- Images will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é¡µé¢åŠ è½½å‰æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å®šæ—¶å™¨å’Œè¯·æ±‚
window.addEventListener('beforeunload', function() {
    console.log('é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº...');
    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    for (let i = 1; i < 9999; i++) {
        window.clearInterval(i);
        window.clearTimeout(i);
    }
});

// ç«‹å³æ¸…ç†ä»»ä½•æ®‹ç•™çš„å®šæ—¶å™¨
console.log('ç«‹å³æ¸…ç†æ®‹ç•™å®šæ—¶å™¨...');
for (let i = 1; i < 9999; i++) {
    window.clearInterval(i);
    window.clearTimeout(i);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('PDFé¡µé¢åˆå§‹åŒ–å¼€å§‹...');
    
    const uploadArea = document.getElementById('pdfUploadArea');
    const fileInput = document.getElementById('pdfFileInput');
    const fileInfoSection = document.getElementById('fileInfoSection');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const parseBtn = document.getElementById('parseBtn');
    const clearPdfBtn = document.getElementById('clearPdfBtn');
    const parseBtnText = document.getElementById('parseBtnText');
    const parseImagesCheckbox = document.getElementById('parseImagesCheckbox');
    const previewSection = document.getElementById('previewSection');
    const pdfPreview = document.getElementById('pdfPreview');
    const processingSection = document.getElementById('processingSection');
    const processingText = document.getElementById('processingText');    const processingProgress = document.getElementById('processingProgress');
    const resultsSection = document.getElementById('resultsSection');
    const markdownContent = document.getElementById('markdownContent');    const copyMarkdownBtn = document.getElementById('copyMarkdownBtn');
    const imagesSection = document.getElementById('imagesSection');
    const imagesContainer = document.getElementById('imagesContainer');

    let currentFile = null;
    let isProcessing = false;    console.log('åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½...');
    // Setup drag and drop
    setupDragAndDrop('pdfUploadArea', 'pdfFileInput', handleFile);

    // æ·»åŠ é¢å¤–çš„ç‚¹å‡»ç›‘å¬å™¨ç”¨äºè°ƒè¯•
    if (uploadArea) {
        uploadArea.addEventListener('click', function() {
            console.log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
            if (fileInput) {
                console.log('è§¦å‘æ–‡ä»¶é€‰æ‹©');
                fileInput.click();
            } else {
                console.error('fileInput å…ƒç´ ä¸å­˜åœ¨');
            }
        });
    } else {
        console.error('uploadArea å…ƒç´ ä¸å­˜åœ¨');
    }

    // Clear button
    clearPdfBtn.addEventListener('click', function() {
        currentFile = null;
        fileInput.value = '';
        fileInfoSection.style.display = 'none';
        previewSection.style.display = 'none';
        processingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        showAlert('å·²é‡æ–°é€‰æ‹©æ–‡ä»¶', 'info');
    });

    // Parse button
    parseBtn.addEventListener('click', function() {
        if (!currentFile || isProcessing) return;
        startParsing();
    });

    // Copy markdown button
    copyMarkdownBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(markdownContent.textContent).then(() => {
            showAlert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
            showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
        });
    });    function handleFile(files) {
        console.log('handleFile è¢«è°ƒç”¨ï¼Œæ–‡ä»¶æ•°é‡:', files.length);
        if (files.length === 0) return;
        
        const file = files[0];
        console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name, file.type);
        
        if (file.type !== 'application/pdf') {
            showAlert('è¯·é€‰æ‹©ä¸€ä¸ªPDFæ–‡ä»¶', 'warning');
            return;
        }

        currentFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfoSection.style.display = 'block';
        
        console.log('æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯åŒºåŸŸ');
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            if (pdfPreview) {
                pdfPreview.src = e.target.result;
                previewSection.style.display = 'block';
                console.log('æ˜¾ç¤ºPDFé¢„è§ˆ');
            }
        };
        reader.readAsDataURL(file);

        // Hide previous results
        processingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        
        showAlert(`å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'success');
    }    async function startParsing() {
        if (!currentFile) return;

        isProcessing = true;
        parseBtn.disabled = true;
        parseBtnText.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>æ­£åœ¨å¤„ç†...';
        processingSection.style.display = 'block';
        processingText.textContent = 'æ­£åœ¨å¤„ç†PDFæ–‡æ¡£...';
        processingProgress.style.width = '0%';

        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('parse_images', parseImagesCheckbox.checked);
        
        console.log('parse_images checkboxçŠ¶æ€:', parseImagesCheckbox.checked);
        console.log('å‘é€çš„parse_imageså€¼:', formData.get('parse_images'));

        try {
            const response = await fetch(`${window.API_BASE_URL}/upload/pdf`, {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                const result = await response.json();
                showAlert(`PDFæ–‡ä»¶å¤„ç†æˆåŠŸï¼Œå¤„ç†ID: ${result.processing_id}`, 'success');
                
                // ç›´æ¥æ˜¾ç¤ºç»“æœï¼ˆå› ä¸ºå¤„ç†æ˜¯åŒæ­¥çš„ï¼‰
                displayResults(result);
                processingProgress.style.width = '100%';
                processingText.textContent = 'å¤„ç†å®Œæˆï¼';
                showAlert('PDFè§£æå®Œæˆï¼', 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || response.statusText);
            }
        } catch (error) {
            console.error('Upload error:', error);
            showAlert(`PDFä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        } finally {
            resetProcessingState();
        }    }

    function displayResults(data) {
        // é€‚åº”æ–°çš„å“åº”ç»“æ„
        markdownContent.textContent = data.markdown_content;
        resultsSection.style.display = 'block';

        // æ£€æŸ¥å¤„ç†ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡
        if (data.processing_info && data.processing_info.images_processed) {
            // ä»markdownå†…å®¹ä¸­æå–å›¾ç‰‡æ–‡ä»¶å
            const imageMatches = data.markdown_content.match(/!\[.*?\]\((.*?)\)/g);
            if (imageMatches && imageMatches.length > 0) {
                imagesContainer.innerHTML = '';
                imageMatches.forEach(match => {
                    const urlMatch = match.match(/!\[.*?\]\((.*?)\)/);
                    if (urlMatch && urlMatch[1]) {
                        const imageUrl = urlMatch[1];
                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
                        const fullImageUrl = imageUrl.startsWith('http') ? 
                            imageUrl : 
                            `${window.API_BASE_URL}${imageUrl.startsWith('/') ? '' : '/'}${imageUrl}`;
                        
                        const imageItem = document.createElement('div');
                        imageItem.style.cssText = 'border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; background: white;';
                        imageItem.innerHTML = `
                            <img src="${fullImageUrl}" style="width: 100%; height: 120px; object-fit: cover; display: block;" onerror="this.style.display='none'">
                            <div style="padding: 8px; text-align: center;">
                                <a href="${fullImageUrl}" target="_blank" style="color: #1890ff; text-decoration: none; font-size: 12px;">æŸ¥çœ‹å¤§å›¾</a>
                            </div>
                        `;
                        imagesContainer.appendChild(imageItem);
                    }
                });
                imagesSection.style.display = 'block';
            } else {
                imagesSection.style.display = 'none';
            }
        } else {
            imagesSection.style.display = 'none';
        }

        // Hide processing section after a delay
        setTimeout(() => {
            processingSection.style.display = 'none';
        }, 2000);
    }    function resetProcessingState() {
        isProcessing = false;
        parseBtn.disabled = false;
        parseBtnText.textContent = 'å¼€å§‹è§£æ';
    }

    // Add CSS for spinner animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
